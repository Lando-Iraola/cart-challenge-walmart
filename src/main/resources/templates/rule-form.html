<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Rule Engine | Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; color: #334155; }
        .dashboard-card { border: none; border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); background: white; }
        .section-title { font-weight: 800; letter-spacing: -0.8px; color: #0f172a; }
        .form-label { font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: #64748b; letter-spacing: 0.025em; }
        .btn-primary { background-color: #4f46e5; border: none; font-weight: 600; border-radius: 12px; transition: all 0.2s; }
        .btn-primary:hover { background-color: #4338ca; transform: translateY(-1px); }
        .target-box { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; }
        .logic-panel { background: #fdf2f2; border-left: 4px solid #ef4444; border-radius: 8px; }
        .logic-panel-discount { background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 8px; }
        .table thead th { background: transparent; color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; border-bottom-width: 1px; }
        .badge-brand { background-color: #dbeafe; color: #1e40af; }
        .badge-product { background-color: #f3f4f6; color: #374151; }
        .badge-processor { background-color: #1e293b; color: #f8fafc; }
    </style>
</head>
<body class="py-5">

<div class="container">
    <div class="row mb-5">
        <div class="col-md-8">
            <h1 class="section-title">⚖️ Rule Engine</h1>
            <p class="text-muted">Apply multi-target logic for bulk promotions or flat discounts.</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="/cart" class="btn btn-outline-dark px-4 rounded-pill">Cart Simulator</a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card dashboard-card p-4">
                <form th:action="@{/rules/save}" method="post">
                    <h5 class="fw-bold mb-4">Rule Builder</h5>
                    
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Rule Behavior</label>
                            <select name="ruleType" id="ruleType" class="form-select border-0 bg-light py-2" onchange="toggleLogicFields()" required>
                                <option value="DISCOUNT">Flat Percentage (%)</option>
                                <option value="PROMO">Buy X Pay Y (Bulk)</option>
                            </select>
                        </div>

                        <div class="col-md-8">
                            <label class="form-label">Internal Description</label>
                            <input type="text" name="description" class="form-control border-0 bg-light" placeholder="e.g. Summer Promo" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Weight</label>
                            <input type="number" name="weight" class="form-control border-0 bg-light" value="1">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Targets (Multiple allowed)</label>
                            <div class="target-box p-3">
                                <select name="productId" class="form-select form-select-sm mb-2 border-0 shadow-sm">
                                    <option value="">+ Specific Product</option>
                                    <option th:each="p : ${products}" th:value="${p.id}" th:text="${p.name}"></option>
                                </select>
                                <select name="brandId" class="form-select form-select-sm mb-2 border-0 shadow-sm">
                                    <option value="">+ Whole Brand</option>
                                    <option th:each="b : ${brands}" th:value="${b.id}" th:text="${b.name}"></option>
                                </select>
                                <select name="processorId" class="form-select form-select-sm border-0 shadow-sm">
                                    <option value="">+ Payment Processor</option>
                                    <option th:each="proc : ${processors}" th:value="${proc.id}" th:text="${proc.name}"></option>
                                </select>
                            </div>
                        </div>

                        <div id="promoFields" style="display:none;" class="col-12">
                            <div class="logic-panel p-3">
                                <label class="form-label text-danger">Promo Logic</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <input type="number" name="threshold" class="form-control form-control-sm" placeholder="Buy 3">
                                    </div>
                                    <div class="col-4">
                                        <input type="number" name="magnitude" class="form-control form-control-sm" placeholder="Pay 2">
                                    </div>
                                    <div class="col-4">
                                        <input type="number" name="maxApps" class="form-control form-control-sm" placeholder="Limit">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="discountFields" class="col-12">
                            <div class="logic-panel-discount p-3">
                                <label class="form-label text-success">Discount Logic</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text border-0 bg-white">%</span>
                                    <input type="number" step="0.0001" name="flatRate" class="form-control border-0" placeholder="0.10 for 10% Off">
                                </div>
                            </div>
                        </div>

                        <div class="col-12 py-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="stackable" id="stack" checked>
                                <label class="form-label mb-0 ms-2" for="stack">Allow Stacking</label>
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100 py-3 shadow-sm">Deploy New Rule</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card dashboard-card p-4">
                <h5 class="fw-bold mb-4">Active Strategy</h5>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Weight</th>
                                <th>Type</th>
                                <th>Targets</th>
                                <th>Effect</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="r : ${rules}">
                                <td th:text="${r.weight}" class="fw-bold text-muted"></td>
                                <td>
                                    <div th:text="${r.description}" class="fw-bold small"></div>
                                    <small th:text="${r instanceof T(com.test_shop.cart.model.rules.PromoRule) ? 'Bulk Promo' : 'Flat Discount'}" class="text-muted"></small>
                                </td>
                                <td>
                                    <span th:each="b : ${r.targetBrands}" class="badge badge-brand me-1" th:text="${b.name}"></span>
                                    <span th:each="p : ${r.targetProducts}" class="badge badge-product me-1" th:text="${p.name}"></span>
                                    <span th:each="pr : ${r.targetProcessors}" class="badge badge-processor me-1" th:text="${pr.name}"></span>
                                </td>
                                <td class="small fw-bold">
                                    <span th:if="${r instanceof T(com.test_shop.cart.model.rules.PromoRule)}" th:text="${r.quantityThreshold} + 'x' + ${r.discountMagnitude}" class="text-danger"></span>
                                    <span th:if="${r instanceof T(com.test_shop.cart.model.rules.DiscountRule)}" th:text="${#numbers.formatPercent(r.flatRateDiscount, 1, 0)} + ' Off'" class="text-success"></span>
                                </td>
                                <td class="text-end">
                                    <form th:action="@{/rules/delete/{id}(id=${r.id})}" method="post">
                                        <button class="btn btn-link text-decoration-none text-danger p-0">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(rules)}">
                                <td colspan="5" class="text-center py-5 text-muted small italic">No rules currently defining the market.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleLogicFields() {
    const type = document.getElementById('ruleType').value;
    document.getElementById('promoFields').style.display = (type === 'PROMO') ? 'block' : 'none';
    document.getElementById('discountFields').style.display = (type === 'DISCOUNT') ? 'block' : 'none';
}
// Run once on load to sync initial select value
document.addEventListener("DOMContentLoaded", toggleLogicFields);
</script>
</body>
</html>